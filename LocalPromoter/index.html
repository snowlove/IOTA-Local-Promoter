<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>IOTA local PoW Promotion / Reattachment tool</title>
		
		<script type="text/javascript" src="libs/iota.min.js"></script>
		<script type="text/javascript" src="libs/curl.min.js"></script>
		<script type="text/javascript" src="libs/iota.extensions.js"></script>

<script>
	var iota, node, logElement;

	var user = {
		nodes : '',
		hashes : [],
		hashIndex : 0,
		promo : 0,
		promoMax : 5,
		params : { interrupt : function() { if(user.promo > 0) { print(user.promo.toString() + "/" + user.promoMax.toString() + " promotions :: " + user.hashes[user.hashIndex]); } if(user.interrupt) return true; else return user.promo++ >= user.promoMax; }, delay: 200 },
		interrupt : false,
		inclusionworker : false
	}
	/*
	* Partial by   : snowlove
	* website      :  https://cindar.me
	* LICENSE    : Creative Commons [BY][SA][NC] : https://creativecommons.org/licenses/by-nc-sa/3.0/legalcode.txt
	*/

	function timestamp() {
		var date = new Date();
		var hh = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
		var mm = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
		var ss = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
		time = hh + ":" + mm + ":" + ss;
		
		delete date; //I don't know if objects get disposed of after a function is ran in javascript
		return time;
	}


	function print(msg, e=false, type=null) {
		if(e) Toggle_Submit();
		var tmp;
		var logline = document.createElement("div");
		tmp = "[" + timestamp() + "]: ";
		if(type == 1) { //warning
			tmp += '<span class="badge badge-warning">Warning</span> ';
		} else if(type == 2) { //success
			tmp += '<span class="badge badge-success">Success</span> ';
		} else if (type == 3) { //danger
			tmp += '<span class="badge badge-danger">Error</span> ';
		} else if (type == 4) { //info
			tmp += '<span class="badge badge-info">Info</span> ';
		} else if (type == 5) { //'primary' the orange one
			tmp += '<span class="badge badge-primary">' + 'amsg' + '</span> ';
		}
		
		tmp += msg;
		
		logline.innerHTML = tmp;
		logElement.insertBefore(logline, logElement.firstChild);
	}

	
	/* validatefield(value, sender) */
	/* returns bool */
	function validatefield(v, s) {
		if(s == 'hash') {
			if(!v || !iota.valid.isHash(v)) {
				print("Invalid hash detected :: " + v.toString(), true, 3);
				return false;
			} else {
				return true;
			}
		}
		
		if(s == 'node') {
			var gruber = /\b((?:https?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i;
			if(!v || !gruber.exec(v)) {
				print("Invalid node", true, 3);
				return false;
			} else {
				return true;
			}
		}
	}
	
	
	/* Check for webgl support because it's required. */
	function webgl_support() {
		try{ var canvas = document.createElement( 'canvas' ); return !! window.WebGLRenderingContext && (canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ); }catch( e ) { return false; }
	}
	
	
	function pageLoaded() {
		if(!iota) iota = new IOTA();
		iota.api.attachToTangle = iota.localAttachToTangle;
		iota.api.__proto__.attachToTangle = iota.localAttachToTangle;
		iota.api.interruptAttachingToTangle = iota.localInterruptAttachingToTangle;
		iota.api.__proto__.interruptAttachingToTangle = iota.localInterruptAttachingToTangle;
		logElement = document.getElementById("eventLogContent");
		print("Testing for WebGL...");
		
		if(webgl_support())
			print("WebGL enabled READY, SET, GO!",false,2);
		else
			print("WebGL not enabled. [<a href=\"https://www.google.com/search?q=How+do+I+enable+WebGL&ie=utf-8\">Click here</a>] for help enabling it.", true, 3);	
	}

	
	function inclusionWorker() { //this should be the only function to remove a hash, outside of invalid hash during validation.
		if(user.hashes.length < 1) return;
		var secrethappyhash = user.hashes;
		
		function checkInclusion (err, isIncluded) {
			var tmp = [];
			var c = 0;
			var offset = 0;

			print("[InclusionWorker] checking hash confirmation states...", false, 4);

			isIncluded.forEach(function(v) {
				if(v) {
					if(user.hashes[user.hashIndex] == user.hashes[c]) user.interrupt = true;
					print("[InclusionWorker] " + user.hashes[c] + " confirmed", false, 2);
					tmp.push(c);
				}
				c++;
			});
			
			tmp.forEach(function(v) {
				user.hashes.splice(v-offset, 1); offset++;
			});
			
			if(user.hashes.length > 0) {
				setTimeout(function () { iota.api.getLatestInclusion(user.hashes, checkInclusion) }, 15000);
			} else {
				print("[InclusionWorker] all hashes confirmed");
				user.inclusionworker = false;
			}
		}
		print("[InclusionWorker] initializing");
		iota.api.getLatestInclusion(user.hashes, checkInclusion);
	}

	
	function Toggle_Submit() {
		if(document.getElementById("promote-submit").disabled == true)
		{
			document.getElementById("promote-submit").disabled = false;
			document.getElementById("reattach-submit").disabled = false;
		} else {
			document.getElementById("promote-submit").disabled = true;
			document.getElementById("reattach-submit").disabled = true;
		}
	}


	/*****************
	*	testing area
	*	-
	*	var x = utils.isBundle(); api.isPromotable() true / false
	*****************/
	function TestFunction(hash, node) {
		print("This is a button I use for testing new features :)");
		iota._makeRequest.provider = node;
		iota.api.getLatestInclusion([document.getElementById("TransactionHash").value], function (e,s) {
	if(e) console.log(e);

	if(s) console.log(s);
});
	}
	

	/***************************************
	*			function attribution by:
	*						Orth
	*			Modified by Snowlove
	*	To find the latest attachment tail
	****************************************/
	function get_tail_tx(hash, promote=0) {
		//print("searching for tail", false, 4);
		iota.api.findTransactionObjects({'bundles': [hash]}, (err, bundle) => {
		if (err || bundle.length == 0) {
			iota.api.getTransactionsObjects([hash], (err, tx) => {
			if (err) {
				print("Unable to locate tail", true, 3);
				return;
			}
			get_tail_tx(tx[0].bundle, promote);
			})
		} else {
			var tmpObj = [];
			
			bundle.forEach(function(v) {
				if(v.currentIndex == 0) {
					if(typeof tmpObj[0] == 'undefined')
						tmpObj.push(v)
					else
						if(v.attachmentTimestamp > tmpObj[0].attachmentTimestamp) {
							tmpObj.pop();
							tmpObj.push(v);
						}
				}
			});
			
			if(promote == 43)
				return tmpObj[0].hash;
			
			print("Tail found :: " + tmpObj[0].hash + " Starting again..", false, 2);
			
			if(promote == 1) //[1] if I do promote_transaction(get_tail_tx(hash)) it'll fire off instantly before getting a hash back from get_tail_tx so it will be null and error. so I added this for the time being
				Promote_Transaction(tmpObj[0].hash);
			else
				reattachTransaction(tmpObj[0].hash);
				
			//return tmpObj[0].hash; //see [1]
		}
		});
	}


	function Worker_DoWork(sender, hash) {
		//Get hash timestamp
		//if > 10m { reattach } else { promote }
	}

	
	function preflight(hash, node, btn) {
		var preprocess = 0;
		var invalidHash = false;
		
		print("Starting...", true, 4);
		if(!validatefield(node, 'node')) return; else iota._makeRequest.provider = node;
		
		if(hash.match(/(?:\r\n|\r|\n|\s)/g))
			hash = hash.replace(/(?:\r\n|\r|\n|\s)/g, '');
			
		user.hashes = hash.split(',');
		
		user.hashes.forEach(async function(v) {
			print("Processing " + preprocess + "/" + user.hashes.length.toString(), false, 4);
			if(!validatefield(v, 'hash')) invalidHash = true;
			var x = await get_tail_tx(v, 43);
			if(x != v) {
				user.hashes[preprocess] = x; print("HASH WAS OFF :: " + v + " :: " + x);
} else { print("HASH WAS GOOD"); }
			preprocess++;
		});
		print("shit");
		return;
		if(invalidHash || user.hashes.length < 0) {
			print("Stopping... Either there was an invalid hash or no hashes at all were detected.", false, 3);
			return;
		}
		

		user.hashIndex = 0;
		user.interrupt = false;
		user.promo = 0;
		//run logic
		if(!user.inclusionworker) {
			inclusionWorker();
			user.inclusionworker = true;
		}
		
		if (btn == "promote") {
			if(iota.api.isPromotable(user.hashes[user.hashIndex])) {
				iota.api.getLatestInclusion([user.hashes[user.hashIndex]], function(e, s) {
					if(!s[0]) Promote_Transaction(user.hashes[user.hashIndex]);
				});
			} else {
				print("Transaction not promotable, reattaching instead", false, 4);
				reattachTransaction(user.hashes[user.hashIndex]);
			}
		} else if (btn == "reattach") {
			reattachTransaction(user.hashes[user.hashIndex]);
		} else {
			print("stop breaking things.", true, 2);
		}
	}


	function reattachTransaction(hash) {
		print("starting reattachment", false, 4);
		iota.api.replayBundle(hash, 3, 14, function(e, s) {
			if(s) {
				var i=0;
				user.hashes.forEach(function(v) {
					if (v == hash)
						user.hashes[i] = s[0].hash;
					i++;
				});
				print("Reattached sucessful :: " + s[0].hash.toString(), true, 2);
				//add logic-ONE EIGHT HUNDRED YALLLLLLL WOOOOOO... to continue through the hashes array
			}
			
			if(e) {
				if (e.toString().includes("tail")) {
					print("stopped :: hash is not the transaction tail", false, 1);
					print("Finding tail....", 4);
					get_tail_tx(hash);
				} else { print(e, true, 3); }
			}
		});
	}

	
	function Promote_Transaction(hash) {
		print("starting promotion", false, 4);
		const transfer = [{
			address: "IS9SOMEONE9GETTING9THE9BEST9THE9BEST9THE9BEST9THE9BEST9OF9YOU9SNOWLOVE99999999999",
			value: 0,
			message: "BCBDCDKD9DCDJDTCEASCCDBDTCEAKDTCBDHDEAPCBDSCEAIDGDTCSCEATBPCJDPCGDRCFDXCDDHDEAKDWCCDEAKDCDID9DSCEACDUCEAHDWCIDBDZCEAXCHDSAEAFDTCSCSCXCHDSARCCDADTAFDTAXCCDHDPCGDIDDDDDCDFDHD",
			tag: "999SNOWLOVE"
		}];

		iota.api.promoteTransaction(hash, 3, 14, transfer, user.params, function(e, s) {
			if (s) {
				if(user.hashes.length > 0 && user.hashes.length > user.hashIndex) {
					//user.hashes.shift();
					//if(!validatefield(user.hashes[0], 'hash')) {
						//print("stopping... error with the next in line hash :: " + user.hashes[0], false, 3);
						//return;
					//}

					print("Promoting next hash: " + user.hashes[user.hashIndex + 1], false, 4);
					user.promo = 0;
					user.interrupt = false;
					Promote_Transaction(user.hashes[++user.hashIndex]);
				} else {
					print("All promotions finished!", true, 2);
				}
			}
			
			if(e) {
				if(e.toString().includes("Inconsistent")) {
					print("stopped :: Inconsistent subtangle. Reattaching...", false, 1);
					reattachTransaction(user.hashes[user.hashIndex]);
					//TODO :: Reattach every x minutes instead.
				} else if (e.toString().includes("tail") || e.toString().includes("too old")) {
					print("stopped :: hash is not the transaction tail", false, 1);
					print("Finding tail....", false, 4);
					get_tail_tx(user.hashes[user.hashIndex], 1);
				} else if (e.toString().includes("Invalid transaction")) {
					print("stopped :: Invalid Transaction", true, 3);
				} else if (e.toString().includes('tip')) {
					print("Hiccup starting promotion again.", false, 1);
					user.promo = 0;
					user.interrupt = false
					Promote_Transaction(user.hashes[user.hashIndex]);
				} else {
					console.log(e);
					print("stopped :: general error :: resubmit", true, 3);
				}
			}
		});
	}
	
window.onload = pageLoaded;
</script>

<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.3/superhero/bootstrap.min.css" rel="stylesheet" integrity="sha384-5wAMKUlGYMj+I1P0kUCCwryZKMvv4S6K2e0UlixY5YK3Z4/HWKP9MtELCm0Iyo74" crossorigin="anonymous">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
<style type="text/css">
html, body { margin: 0;padding: 0;height: calc(100% - 60px);position: relative;width: 100%; }
.incwrap { margin: auto;width: 80%;padding-bottom: 100px; }

.navbar { min-height:  55px; margin-bottom: 20px; }
main { min-width: 900px;min-height: 100%; }
.form-control.number { width: auto; }
.form-control[type="color"] { width : 60px; padding : 2px; display : inline-block; }
.form-control[multiple] { height : auto; }
.form-control { width: 75%; display: inline-block; margin-top: 5px; }
label { padding-right: 5px; display: inline-block; width: 55px; font-weight: bold; } 

.border-light { color: white; }
pre > div > a { color: #E49647; }
pre > div > a:hover { color:#FFF; text-decoration:none; }
.badge { min-width:45px; }
footer { line-height: 45px; top: 0; position: relative; width: 100%; background-color:#4e5d6c; color: #FFF; overflow:auto; text-align:center; }
.fsStoreF { font-size: 1.2em; }
.fb-button.form-group.field-promote-submit { padding-left: 45px; }
.btn { width: 200px; }
.btn-addition { margin-left: 10px; }
.hidden { display: none; }
.provider { position: absolute; padding-right: 15px; right: 0px; } /* at Ralfs request, added link to the main iota.fm site since he's so kind to let us use his nodes as default. */
</style>

</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<a class="navbar-brand" href="#">Local PoW</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation" style="">
		<span class="navbar-toggler-icon"></span>
	</button>
	
	<div class="collapse navbar-collapse" id="navbarColor02">
		<ul class="navbar-nav mr-auto">
		<li class="nav-item active">
			<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="https://github.com/snowlove/IOTA-Local-Promoter">Project Github</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="https://discord.gg/fNGZXvh">IOTA Official Discord</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="https://www.reddit.com/r/IOTASupport/">IOTA Support subreddit</a>
		</li>
		</ul>
	</div>
	</nav>
	
	
	
	<main>
		<div class="incwrap">
		<form id="rendered-form">
			<div class="fb-text form-group field-promote-tx-hash-field">
				<label for="TransactionHash" style="vertical-align:top">Hash </label><textarea class="form-control" placeholder="Input a single hash or a list of hashes seperated by a comma. e.g. hash1,hash2,hash3,hash4" name="TransactionHash" id="TransactionHash" rows="2"></textarea><br />
				<label for="node">Node </label><input type="text" placeholder="http://iota.nodeaddress.com:9999" value="http://nodes.iota.fm:80" class="form-control" name="node" id="node" />
			</div>
			<div class="fb-button form-group field-promote-submit">
				<button type="button" class="btn btn-primary" name="promote-submit" style="default" id="promote-submit" onClick="preflight(TransactionHash.value, node.value, 'promote');">Promote</button>
				<button type="button" class="btn btn-primary btn-addition" name="reattach-submit" style="default" id="reattach-submit" onClick="preflight(TransactionHash.value, node.value, 'reattach');">Reattach</button>
				<button type="button" class="btn btn-primary btn-addition" name="reattach-submit" style="default" id="reattach-submit" onClick="TestFunction(TransactionHash.value, node.value);">Test Function</button>
			</div>
		</form>
		
		<pre class="panel-body text-left card border-light mb-3" style="height:400px; overflow:auto; padding:5px;" id="eventLogContent"></pre>

		<p>Did this tool help you? Please donate to help create more tools like this: <span class="badge badge-light">OJVPGSRTVELYUW9IHEEBNJQCQXPMXNKFVTWW9ADLYYPDGXWQRACPGQSZCOHUVQSGWKMBNIZNXVYWULCUWDQLIGPALD</span></p>
		</div>
	</main>
	<footer class="fsStoref">
		<span class="ftext">By Snowlove - Rajiv (Original idea) - GpanosXP (Local PoW)</span><span class="provider">Default node provided by <a href="http://iota.fm">iota.fm</a></span>
	</footer>
</body>
</html>